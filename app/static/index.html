<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>RetailAI — Dashboard</title>
<link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
<style>
  body { background: #f3f6fb; }
  .brand { display:flex; gap:10px; align-items:center }
</style>
</head>
<body class="min-h-screen antialiased">
  <div class="max-w-7xl mx-auto p-6">
    <header class="flex items-center justify-between mb-6">
      <div class="brand">
        <!-- Basit logo (SVG) -->
        <div class="w-12 h-12 bg-white rounded-lg flex items-center justify-center shadow">
          <svg width="36" height="36" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <rect x="1" y="3" width="22" height="18" rx="3" fill="#1f7aec"/>
            <path d="M6 8h12M6 12h12M6 16h8" stroke="white" stroke-width="1.4" stroke-linecap="round"/>
          </svg>
        </div>
        <div>
          <div class="text-xl font-semibold">RetailAI</div>
          <div class="text-sm text-gray-500">Akıllı Stok & SKT Yönetimi</div>
        </div>
      </div>

      <nav class="flex items-center gap-4">
        <a href="/ui/invoice.html" class="text-sm text-gray-700 hover:text-blue-600">Fatura Detay</a>
        <a href="/ui/products.html" class="text-sm text-gray-700 hover:text-blue-600">Ürünler</a>
        <a href="/ui/products.html" class="text-sm text-gray-700 hover:text-blue-600">Bulk Import</a>
        <a href="/docs" class="text-sm text-gray-700 hover:text-blue-600">API</a>
        <button id="btnDemo" class="bg-blue-600 text-white px-3 py-1 rounded">Uyarılar & Demo</button>
      </nav>
    </header>

    <main>
      <section class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
        <div class="bg-white p-4 rounded shadow">
          <div class="text-sm text-gray-500">SKT Yaklaşan (7 gün)</div>
          <div id="cardExpiry" class="mt-3 text-2xl font-semibold">—</div>
          <div id="cardExpiryMeta" class="text-sm text-gray-400 mt-1">yükleniyor...</div>
        </div>
        <div class="bg-white p-4 rounded shadow">
          <div class="text-sm text-gray-500">Stok Azalan</div>
          <div id="cardLowStock" class="mt-3 text-2xl font-semibold">—</div>
          <div id="cardLowStockMeta" class="text-sm text-gray-400 mt-1">yükleniyor...</div>
        </div>
        <div class="bg-white p-4 rounded shadow">
          <div class="text-sm text-gray-500">Günlük Potansiyel Fire Tasarrufu</div>
          <div id="cardSave" class="mt-3 text-2xl font-semibold">—</div>
          <div id="cardSaveMeta" class="text-sm text-gray-400 mt-1">hesaplanıyor...</div>
        </div>
      </section>

      <section class="grid grid-cols-1 lg:grid-cols-3 gap-4">
        <div class="col-span-2 bg-white p-4 rounded shadow">
          <div class="flex items-center justify-between">
            <h2 class="text-lg font-semibold">Bugün yapılacaklar</h2>
            <a href="/ui/invoice.html" class="text-sm text-blue-600">Tümünü gör</a>
          </div>
          <table class="w-full text-left mt-3">
            <thead class="text-sm text-gray-500">
              <tr><th class="py-2">Ürün / Invoice</th><th>Durum</th><th>Öneri</th><th></th></tr>
            </thead>
            <tbody id="todoRows" class="text-sm">
              <tr class="border-t"><td class="py-2">Yükleniyor...</td><td class="py-2">-</td><td class="py-2">-</td><td class="py-2 text-right"></td></tr>
            </tbody>
          </table>
        </div>

        <div class="bg-white p-4 rounded shadow">
          <h3 class="text-lg font-semibold">Hızlı Arama</h3>
          <div class="mt-3">
            <input id="q" class="w-full border rounded px-2 py-1" placeholder="Ürün barkodu / isim girin"/>
            <div id="searchRes" class="text-sm text-gray-500 mt-2">0 sonuç</div>
          </div>
        </div>
      </section>

      <section class="mt-6 bg-white p-4 rounded shadow">
        <div class="flex items-center justify-between mb-3">
          <h2 class="text-lg font-semibold">Stok Trendi (Son 7 Gün)</h2>
          <div class="text-xs text-gray-400" id="chartNote">Demo verisi</div>
        </div>
        <div style="position: relative; height: 250px;">
          <canvas id="stockTrendChart"></canvas>
        </div>
      </section>

      <footer class="mt-8 text-sm text-gray-400">
        RetailAI © <span id="year"></span> — Demo & Pilot amaçlı. Sunumda müşteri onayı ile logo/isim değiştirilebilir.
      </footer>
    </main>
  </div>

<script>
  document.getElementById('year').textContent = new Date().getFullYear();

  // Dashboard data loader: çağır /dashboard/summary ve DOM'u güncelle
  async function loadDashboard() {
    const expiryEl = document.getElementById('cardExpiry');
    const expiryMeta = document.getElementById('cardExpiryMeta');
    const lowEl = document.getElementById('cardLowStock');
    const lowMeta = document.getElementById('cardLowStockMeta');
    const saveEl = document.getElementById('cardSave');
    const saveMeta = document.getElementById('cardSaveMeta');
    const todoRows = document.getElementById('todoRows');

    expiryEl.textContent = '…';
    lowEl.textContent = '…';
    saveEl.textContent = '…';
    expiryMeta.textContent = 'yükleniyor...';
    lowMeta.textContent = 'yükleniyor...';
    saveMeta.textContent = 'hesaplanıyor...';

    try {
      const resp = await fetch('/dashboard/summary?store_id=1&days=7', {cache:'no-store'});
      if(!resp.ok) throw new Error('Status ' + resp.status);
      const j = await resp.json();

      // expiry count
      expiryEl.textContent = (j.expiry_count ?? 0);
      expiryMeta.textContent = `son ${7} gün içinde ${j.expiry_count ?? 0} uyarı`;

      // low stock
      lowEl.textContent = (j.low_stock_count ?? 0);
      lowMeta.textContent = `${j.low_stock_count ?? 0} ürün stok eşiğinin altında`;

      // rudimentary save calc (demo) — gerçek hesaplama backend'e taşınmalı
      const saveEstimate = ((j.expiry_count ?? 0) * 120).toLocaleString('tr-TR', {style:'currency', currency:'TRY'});
      saveEl.textContent = saveEstimate;
      saveMeta.textContent = 'Tahmini günlük tasarruf';

      // recent invoices -> todoRows
      const rec = j.recent_invoices || [];
      todoRows.innerHTML = '';
      if(rec.length === 0){
        todoRows.innerHTML = '<tr><td colspan="4" class="p-4 text-center text-gray-500">Gösterilecek öğe yok</td></tr>';
      } else {
        rec.forEach(inv => {
          const tr = document.createElement('tr');
          tr.className = 'border-t';
          tr.innerHTML = `
            <td class="py-2">Invoice #${inv.id}</td>
            <td class="py-2 text-gray-600">Satır: ${inv.line_count ?? '-'}</td>
            <td class="py-2">İncele</td>
            <td class="py-2 text-right"><a class="text-xs px-2 py-1 bg-blue-50 text-blue-600 rounded" href="/ui/invoice.html?id=${inv.id}">Aç</a></td>
          `;
          todoRows.appendChild(tr);
        });
      }

    } catch (err) {
      console.error('dashboard load error', err);
      expiryEl.textContent = '!';
      lowEl.textContent = '!';
      saveEl.textContent = '!';
      expiryMeta.textContent = 'veri yüklenemedi';
      lowMeta.textContent = 'veri yüklenemedi';
      saveMeta.textContent = 'veri yüklenemedi';
      todoRows.innerHTML = '<tr><td colspan="4" class="p-4 text-center text-red-600">Veri yüklenemedi — backend çalışıyor mu?</td></tr>';
    }
  }

  // Demo/uyarı butonu: alerts sayfasına yönlendir
  document.getElementById('btnDemo').addEventListener('click', () => {
    window.location.href = '/ui/alerts.html';
  });

  // Basit ürün arama (frontend, hızlı): backend endpoint yoksa sadece placeholder
  document.getElementById('q').addEventListener('input', async (e) => {
    const q = e.target.value.trim();
    const resEl = document.getElementById('searchRes');
    if(!q){ resEl.textContent = '0 sonuç'; return; }
    // Eğer ürün arama endpoint'in varsa burayı değiştir: fetch(`/products/search?q=${encodeURIComponent(q)}`)
    resEl.textContent = 'arama desteklenmiyor (implementasyon gerek)';
  });

  // Stok Trend Grafiği (Gerçek Veri)
  let stockChart = null;
  async function loadStockTrendChart() {
    try {
      const resp = await fetch('/dashboard/stock_trend?store_id=1&days=7', {cache:'no-store'});
      if(!resp.ok) throw new Error('Grafik verisi yüklenemedi');
      const chartData = await resp.json();

      const ctx = document.getElementById('stockTrendChart').getContext('2d');

      // Önceki chart varsa yok et
      if (stockChart) {
        stockChart.destroy();
      }

      stockChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: chartData.labels,
          datasets: [{
            label: 'Stok Seviyesi',
            data: chartData.data,
            borderColor: '#3b82f6',
            backgroundColor: 'rgba(59, 130, 246, 0.1)',
            tension: 0.4,
            fill: true,
            pointRadius: 4,
            pointHoverRadius: 6,
            borderWidth: 2
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              display: true,
              position: 'top'
            },
            tooltip: {
              mode: 'index',
              intersect: false
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                callback: function(value) {
                  return value + ' adet';
                }
              }
            }
          }
        }
      });

      // Chart note güncelle
      if (chartData.note) {
        document.getElementById('chartNote').textContent = chartData.note;
      }
    } catch (err) {
      console.error('Grafik yükleme hatası:', err);
      document.getElementById('chartNote').textContent = 'Grafik yüklenemedi';
    }
  }

  // İlk yükleme ve periyodik yenileme (60s)
  window.addEventListener('load', () => {
    loadDashboard();
    loadStockTrendChart();
    setInterval(() => {
      loadDashboard();
      loadStockTrendChart();
    }, 60000);
  });
</script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>



</body>
</html>