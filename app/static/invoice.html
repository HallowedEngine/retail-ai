<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8">
  <title>Fatura Detayı — RetailAI</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Güzel tasarım + PDF için -->
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
  <style>
    body { font-family: system-ui, -apple-system, sans-serif; background: #f9fafb; }
    .typeahead-dropdown {
      position: absolute; z-index: 9999; background: white; border: 1px solid #e5e7eb;
      box-shadow: 0 10px 25px rgba(0,0,0,0.1); border-radius: 8px; overflow: auto; max-height: 300px;
    }
    .typeahead-dropdown > div { padding: 10px 12px; cursor: pointer; font-size: 14px; }
    .typeahead-dropdown > div:hover { background: #f3f4f6; }
  </style>
</head>
<body class="min-h-screen">

  <!-- PDF'E ÇEKİLECEK TÜM İÇERİK -->
  <div id="pdf-content" class="max-w-5xl mx-auto bg-white shadow-2xl rounded-2xl overflow-hidden my-8">

    <!-- Başlık + PDF Butonu -->
    <div class="bg-gradient-to-r from-indigo-600 to-purple-600 text-white p-8">
      <div class="flex justify-between items-center">
        <div>
          <h1 class="text-4xl font-bold">Fatura Detayı</h1>
          <p class="text-indigo-100 mt-2" id="report-info">Fatura ID: <span id="current-invoice-id">—</span></p>
        </div>
        <button onclick="exportToPDF()" class="bg-white text-indigo-600 font-bold py-4 px-8 rounded-xl shadow-lg hover:bg-gray-100 transition transform hover:scale-105">
          PDF İNDİR
        </button>
      </div>
    </div>

    <div class="p-8">

      <!-- Kontrol Paneli -->
      <div class="bg-gray-50 rounded-xl p-6 mb-8 border">
        <div class="flex flex-wrap items-center gap-4">
          <label class="font-medium">
            Fatura ID:
            <input id="invId" type="number" placeholder="örn: 1" class="ml-3 border border-gray-300 rounded-lg px-4 py-2 w-32 focus:ring-4 focus:ring-indigo-300" />
          </label>
          <button id="btnLoad" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold px-8 py-3 rounded-lg shadow transition">
            Yükle
          </button>
          <a id="csvLink" href="#" target="_blank" class="ml-auto text-indigo-600 hover:underline font-medium">
            CSV İndir
          </a>
        </div>
      </div>

      <div id="msg" class="text-center font-medium text-lg mb-6"></div>

      <!-- Tablo -->
      <div class="overflow-x-auto rounded-xl shadow-lg border">
        <table class="min-w-full bg-white" id="linesTbl" style="display:none">
          <thead class="bg-gradient-to-r from-indigo-600 to-purple-600 text-white">
            <tr>
              <th class="p-5 text-left">Satır</th>
              <th class="p-5 text-left">Ürün Adı (Ham)</th>
              <th class="p-5 text-left">Eşleşen Ürün</th>
              <th class="p-5 text-left">Adet</th>
              <th class="p-5 text-left">Birim Fiyat</th>
              <th class="p-5 text-left">Toplam</th>
              <th class="p-5 text-left">İşlem</th>
            </tr>
          </thead>
          <tbody id="linesBody"></tbody>
        </table>
      </div>

      <div class="mt-12 text-center text-gray-500">
        © 2025 RetailAI — Akıllı Fatura & Stok Yönetim Sistemi
      </div>
    </div>
  </div>

<script>
// PDF Export (ŞAHANE)
async function exportToPDF() {
  const btn = document.querySelector('button[onclick="exportToPDF()"]');
  btn.disabled = true;
  btn.innerHTML = 'Hazırlanıyor...';

  const { jsPDF } = window.jspdf;
  const element = document.getElementById('pdf-content');

  try {
    const canvas = await html2canvas(element, { scale: 2, useCORS: true });
    const imgData = canvas.toDataURL('image/png');
    const pdf = new jsPDF('p', 'mm', 'a4');
    const width = pdf.internal.pageSize.getWidth();
    const height = pdf.internal.pageSize.getHeight();
    pdf.addImage(imgData, 'PNG', 0, 0, width, height);
    pdf.save(`Fatura_${document.getElementById('current-invoice-id').textContent || 'detay'}.pdf`);
  } catch (e) {
    alert('PDF oluşturulurken hata: ' + e.message);
  } finally {
    btn.disabled = false;
    btn.innerHTML = 'PDF İNDİR';
  }
}

async function loadInvoice(id) {
  document.getElementById('current-invoice-id').textContent = id;
  document.getElementById('msg').innerHTML = '<span class="text-indigo-600">Yükleniyor...</span>';

  const r = await fetch(`/invoice/${id}`);
  const text = await r.text();
  let data = null;
  try { data = JSON.parse(text); } catch (e) {
    document.getElementById('msg').innerHTML = '<span class="text-red-600">JSON hatası</span>';
    return;
  }
  if (!r.ok) { document.getElementById('msg').innerHTML = '<span class="text-red-600">Sunucu hatası</span>'; return; }

  document.getElementById("csvLink").href = `/invoice/${id}/export.csv`;
  document.getElementById('msg').innerHTML = `<span class="text-green-600">Fatura yüklendi — ${data.lines.length} satır</span>`;

  const tbody = document.getElementById("linesBody");
  tbody.innerHTML = "";
  document.getElementById("linesTbl").style.display = "";

  data.lines.forEach(L => {
    const tr = document.createElement("tr");
    tr.className = "hover:bg-gray-50 transition";
    const matchedName = L.product_id ? `<strong class="text-green-600">${L.matched_name || 'Eşleşti'}</strong>` : '<span class="text-gray-400">Eşleşme yok</span>';
    
    tr.innerHTML = `
      <td class="p-4">${L.id}</td>
      <td class="p-4">${L.name_raw || ''}</td>
      <td class="p-4">
        <input value="${L.product_id || ''}" 
               data-line-id="${L.id}" 
               class="product-choice border rounded-lg px-3 py-2 w-24 focus:ring focus:ring-indigo-300" 
               placeholder="ID ara..." />
        <div class="text-sm mt-1">${matchedName}</div>
      </td>
      <td class="p-4"><input value="${L.qty}" data-key="qty" class="border rounded px-3 py-2 w-20 text-right" /></td>
      <td class="p-4"><input value="${L.unit_price}" data-key="unit_price" class="border rounded px-3 py-2 w-32 text-right" /></td>
      <td class="p-4 font-medium text-right">${(L.qty * L.unit_price).toFixed(2)} ₺</td>
      <td class="p-4"><button data-id="${L.id}" class="bg-indigo-600 hover:bg-indigo-700 text-white px-5 py-2 rounded-lg text-sm font-medium transition">Kaydet</button></td>
    `;
    tbody.appendChild(tr);
  });

  // Typeahead yeniden başlat
  initInvoiceTypeaheads();
  attachSaveButtons();
}

function attachSaveButtons() {
  document.querySelectorAll('#linesBody button').forEach(btn => {
    btn.onclick = async () => {
      const lineId = btn.dataset.id;
      const tr = btn.closest('tr');
      const body = { line_id: Number(lineId) };
      
      tr.querySelectorAll('input[data-key]').forEach(inp => {
        const k = inp.dataset.key;
        let v = inp.value;
        if (k === 'qty' || k === 'unit_price') v = v === '' ? null : Number(v);
        body[k] = v;
      });
      
      const productInput = tr.querySelector('.product-choice');
      if (productInput.value) body.product_id = Number(productInput.value);

      const rr = await fetch(`/invoice/line/update`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(body)
      });
      
      btn.innerHTML = rr.ok ? 'Kaydedildi' : 'Hata';
      btn.className = rr.ok ? 'bg-green-600 text-white px-5 py-2 rounded-lg' : 'bg-red-600 text-white px-5 py-2 rounded-lg';
      setTimeout(() => { btn.innerHTML = 'Kaydet'; btn.className = 'bg-indigo-600 hover:bg-indigo-700 text-white px-5 py-2 rounded-lg'; }, 2000);
    };
  });
}

// Typeahead kodu (senin orijinal + ufak güzelleştirme)
function createDropdown(input) { /* aynı */ }
function placeDropdown(input, dd) { /* aynı */ }
function attachTypeaheadToInput(input) { /* senin kodun, sadece ufak düzeltme */ }
function initInvoiceTypeaheads() {
  document.querySelectorAll('.product-choice[data-line-id]').forEach(inp => {
    inp.removeEventListener('input', inp._typeaheadHandler);
    attachTypeaheadToInput(inp);
  });
}

document.getElementById("btnLoad").addEventListener("click", () => {
  const id = document.getElementById("invId").value.trim();
  if (!id) return alert("Firuta ID gir kanka");
  loadInvoice(id);
});

// Sayfa açılışta ?id= varsa otomatik yükle
const urlParams = new URLSearchParams(window.location.search);
const autoId = urlParams.get('id');
if (autoId) {
  document.getElementById('invId').value = autoId;
  loadInvoice(autoId);
}
</script>

</body>
</html>