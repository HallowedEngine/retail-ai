<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8">
  <title>Fatura DetayÄ± â€” RetailAI</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- GÃ¼zel tasarÄ±m + PDF iÃ§in -->
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
  <style>
    body { font-family: system-ui, -apple-system, sans-serif; background: #f9fafb; }
    .typeahead-dropdown {
      position: absolute; z-index: 9999; background: white; border: 1px solid #e5e7eb;
      box-shadow: 0 10px 25px rgba(0,0,0,0.1); border-radius: 8px; overflow: auto; max-height: 300px;
    }
    .typeahead-dropdown > div { padding: 10px 12px; cursor: pointer; font-size: 14px; }
    .typeahead-dropdown > div:hover { background: #f3f4f6; }
  </style>
</head>
<body class="min-h-screen">

  <!-- PDF'E Ã‡EKÄ°LECEK TÃœM Ä°Ã‡ERÄ°K -->
  <div id="pdf-content" class="max-w-5xl mx-auto bg-white shadow-2xl rounded-2xl overflow-hidden my-8">

    <!-- BaÅŸlÄ±k + PDF Butonu -->
    <div class="bg-gradient-to-r from-indigo-600 to-purple-600 text-white p-8">
      <div class="flex justify-between items-center">
        <div>
          <h1 class="text-4xl font-bold">Fatura DetayÄ±</h1>
          <p class="text-indigo-100 mt-2" id="report-info">Fatura ID: <span id="current-invoice-id">â€”</span></p>
        </div>
        <button onclick="exportToPDF()" class="bg-white text-indigo-600 font-bold py-4 px-8 rounded-xl shadow-lg hover:bg-gray-100 transition transform hover:scale-105">
          PDF Ä°NDÄ°R
        </button>
      </div>
    </div>

    <div class="p-8">

      <!-- CSV Fatura YÃ¼kleme -->
      <div class="bg-gradient-to-r from-green-50 to-emerald-50 rounded-xl p-6 mb-8 border-2 border-green-200">
        <h2 class="text-xl font-bold text-green-800 mb-4">ğŸ“„ CSV Fatura YÃ¼kle</h2>
        <p class="text-sm text-gray-600 mb-4">
          Format: <code class="bg-white px-2 py-1 rounded">urun_adi, barkod, adet, birim_fiyat, skt_tarihi, kategori</code>
        </p>
        <div class="flex flex-wrap items-center gap-4">
          <input type="file" id="csvFileInvoice" accept=".csv" class="border-2 border-green-300 rounded-lg px-4 py-2 bg-white" />
          <button id="btnUploadCSV" class="bg-green-600 hover:bg-green-700 text-white font-bold px-8 py-3 rounded-lg shadow transition">
            YÃ¼kle & Ä°ÅŸle
          </button>
        </div>
        <div id="csvMsg" class="mt-4 font-medium"></div>
      </div>

      <!-- Kontrol Paneli -->
      <div class="bg-gray-50 rounded-xl p-6 mb-8 border">
        <h2 class="text-xl font-bold text-gray-800 mb-4">ğŸ” Fatura GÃ¶rÃ¼ntÃ¼le</h2>
        <div class="flex flex-wrap items-center gap-4">
          <label class="font-medium">
            Fatura ID:
            <input id="invId" type="number" placeholder="Ã¶rn: 1" class="ml-3 border border-gray-300 rounded-lg px-4 py-2 w-32 focus:ring-4 focus:ring-indigo-300" />
          </label>
          <button id="btnLoad" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold px-8 py-3 rounded-lg shadow transition">
            YÃ¼kle
          </button>
          <a id="csvLink" href="#" target="_blank" class="ml-auto text-indigo-600 hover:underline font-medium">
            CSV Ä°ndir
          </a>
        </div>
      </div>

      <div id="msg" class="text-center font-medium text-lg mb-6"></div>

      <!-- Tablo -->
      <div class="overflow-x-auto rounded-xl shadow-lg border">
        <table class="min-w-full bg-white" id="linesTbl" style="display:none">
          <thead class="bg-gradient-to-r from-indigo-600 to-purple-600 text-white">
            <tr>
              <th class="p-5 text-left">SatÄ±r</th>
              <th class="p-5 text-left">ÃœrÃ¼n AdÄ± (Ham)</th>
              <th class="p-5 text-left">EÅŸleÅŸen ÃœrÃ¼n</th>
              <th class="p-5 text-left">Adet</th>
              <th class="p-5 text-left">Birim Fiyat</th>
              <th class="p-5 text-left">Toplam</th>
              <th class="p-5 text-left">Ä°ÅŸlem</th>
            </tr>
          </thead>
          <tbody id="linesBody"></tbody>
        </table>
      </div>

      <div class="mt-12 text-center text-gray-500">
        Â© 2025 RetailAI â€” AkÄ±llÄ± Fatura & Stok YÃ¶netim Sistemi
      </div>
    </div>
  </div>

<script>
// PDF Export (ÅAHANE)
async function exportToPDF() {
  const btn = document.querySelector('button[onclick="exportToPDF()"]');
  btn.disabled = true;
  btn.innerHTML = 'HazÄ±rlanÄ±yor...';

  const { jsPDF } = window.jspdf;
  const element = document.getElementById('pdf-content');

  try {
    const canvas = await html2canvas(element, { scale: 2, useCORS: true });
    const imgData = canvas.toDataURL('image/png');
    const pdf = new jsPDF('p', 'mm', 'a4');
    const width = pdf.internal.pageSize.getWidth();
    const height = pdf.internal.pageSize.getHeight();
    pdf.addImage(imgData, 'PNG', 0, 0, width, height);
    pdf.save(`Fatura_${document.getElementById('current-invoice-id').textContent || 'detay'}.pdf`);
  } catch (e) {
    alert('PDF oluÅŸturulurken hata: ' + e.message);
  } finally {
    btn.disabled = false;
    btn.innerHTML = 'PDF Ä°NDÄ°R';
  }
}

async function loadInvoice(id) {
  document.getElementById('current-invoice-id').textContent = id;
  document.getElementById('msg').innerHTML = '<span class="text-indigo-600">YÃ¼kleniyor...</span>';

  const r = await fetch(`/invoice/${id}`);
  const text = await r.text();
  let data = null;
  try { data = JSON.parse(text); } catch (e) {
    document.getElementById('msg').innerHTML = '<span class="text-red-600">JSON hatasÄ±</span>';
    return;
  }
  if (!r.ok) { document.getElementById('msg').innerHTML = '<span class="text-red-600">Sunucu hatasÄ±</span>'; return; }

  document.getElementById("csvLink").href = `/invoice/${id}/export.csv`;
  document.getElementById('msg').innerHTML = `<span class="text-green-600">Fatura yÃ¼klendi â€” ${data.lines.length} satÄ±r</span>`;

  const tbody = document.getElementById("linesBody");
  tbody.innerHTML = "";
  document.getElementById("linesTbl").style.display = "";

  data.lines.forEach(L => {
    const tr = document.createElement("tr");
    tr.className = "hover:bg-gray-50 transition";
    const matchedName = L.product_id ? `<strong class="text-green-600">${L.matched_name || 'EÅŸleÅŸti'}</strong>` : '<span class="text-gray-400">EÅŸleÅŸme yok</span>';
    
    tr.innerHTML = `
      <td class="p-4">${L.id}</td>
      <td class="p-4">${L.name_raw || ''}</td>
      <td class="p-4">
        <input value="${L.product_id || ''}" 
               data-line-id="${L.id}" 
               class="product-choice border rounded-lg px-3 py-2 w-24 focus:ring focus:ring-indigo-300" 
               placeholder="ID ara..." />
        <div class="text-sm mt-1">${matchedName}</div>
      </td>
      <td class="p-4"><input value="${L.qty}" data-key="qty" class="border rounded px-3 py-2 w-20 text-right" /></td>
      <td class="p-4"><input value="${L.unit_price}" data-key="unit_price" class="border rounded px-3 py-2 w-32 text-right" /></td>
      <td class="p-4 font-medium text-right">${(L.qty * L.unit_price).toFixed(2)} â‚º</td>
      <td class="p-4"><button data-id="${L.id}" class="bg-indigo-600 hover:bg-indigo-700 text-white px-5 py-2 rounded-lg text-sm font-medium transition">Kaydet</button></td>
    `;
    tbody.appendChild(tr);
  });

  // Typeahead yeniden baÅŸlat
  initInvoiceTypeaheads();
  attachSaveButtons();
}

function attachSaveButtons() {
  document.querySelectorAll('#linesBody button').forEach(btn => {
    btn.onclick = async () => {
      const lineId = btn.dataset.id;
      const tr = btn.closest('tr');
      const body = { line_id: Number(lineId) };
      
      tr.querySelectorAll('input[data-key]').forEach(inp => {
        const k = inp.dataset.key;
        let v = inp.value;
        if (k === 'qty' || k === 'unit_price') v = v === '' ? null : Number(v);
        body[k] = v;
      });
      
      const productInput = tr.querySelector('.product-choice');
      if (productInput.value) body.product_id = Number(productInput.value);

      const rr = await fetch(`/invoice/line/update`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(body)
      });
      
      btn.innerHTML = rr.ok ? 'Kaydedildi' : 'Hata';
      btn.className = rr.ok ? 'bg-green-600 text-white px-5 py-2 rounded-lg' : 'bg-red-600 text-white px-5 py-2 rounded-lg';
      setTimeout(() => { btn.innerHTML = 'Kaydet'; btn.className = 'bg-indigo-600 hover:bg-indigo-700 text-white px-5 py-2 rounded-lg'; }, 2000);
    };
  });
}

// Typeahead autocomplete implementasyonu
function createDropdown(input) {
  const dd = document.createElement('div');
  dd.className = 'typeahead-dropdown';
  dd.style.display = 'none';
  document.body.appendChild(dd);
  return dd;
}

function placeDropdown(input, dd) {
  const rect = input.getBoundingClientRect();
  dd.style.left = rect.left + 'px';
  dd.style.top = (rect.bottom + window.scrollY) + 'px';
  dd.style.width = Math.max(rect.width, 300) + 'px';
}

function attachTypeaheadToInput(input) {
  let dropdown = input._dropdown;
  if (!dropdown) {
    dropdown = createDropdown(input);
    input._dropdown = dropdown;
  }

  const handler = async (e) => {
    const q = e.target.value.trim();
    if (q.length < 2) {
      dropdown.style.display = 'none';
      return;
    }

    try {
      const resp = await fetch(`/products?limit=10`);
      if (!resp.ok) throw new Error('ÃœrÃ¼n arama hatasÄ±');
      const products = await resp.json();

      // Filtreleme: ID, barkod veya isme gÃ¶re
      const filtered = products.filter(p =>
        String(p.id).includes(q) ||
        (p.barcode && p.barcode.includes(q)) ||
        (p.name && p.name.toLowerCase().includes(q.toLowerCase()))
      ).slice(0, 8);

      if (filtered.length === 0) {
        dropdown.style.display = 'none';
        return;
      }

      dropdown.innerHTML = '';
      filtered.forEach(p => {
        const div = document.createElement('div');
        div.innerHTML = `<strong>${p.name || 'Ä°simsiz'}</strong><br><span style="font-size:12px;color:#666;">ID: ${p.id} | Barkod: ${p.barcode || '-'}</span>`;
        div.onclick = () => {
          input.value = p.id;
          dropdown.style.display = 'none';

          // Matched name'i gÃ¼ncelle
          const matchedDiv = input.closest('td').querySelector('.text-sm');
          if (matchedDiv) {
            matchedDiv.innerHTML = `<strong class="text-green-600">${p.name || 'EÅŸleÅŸti'}</strong>`;
          }
        };
        dropdown.appendChild(div);
      });

      placeDropdown(input, dropdown);
      dropdown.style.display = 'block';
    } catch (err) {
      console.error('Typeahead hatasÄ±:', err);
      dropdown.style.display = 'none';
    }
  };

  // Ã–nceki handler'Ä± temizle ve yenisini ekle
  if (input._typeaheadHandler) {
    input.removeEventListener('input', input._typeaheadHandler);
  }
  input._typeaheadHandler = handler;
  input.addEventListener('input', handler);

  // Dropdown'u dÄ±ÅŸarÄ± tÄ±klayÄ±nca kapat
  document.addEventListener('click', (e) => {
    if (e.target !== input && dropdown) {
      dropdown.style.display = 'none';
    }
  });
}

function initInvoiceTypeaheads() {
  document.querySelectorAll('.product-choice[data-line-id]').forEach(inp => {
    attachTypeaheadToInput(inp);
  });
}

document.getElementById("btnLoad").addEventListener("click", () => {
  const id = document.getElementById("invId").value.trim();
  if (!id) return alert("Fatura ID gir lÃ¼tfen");
  loadInvoice(id);
});

// CSV Fatura YÃ¼kleme
document.getElementById("btnUploadCSV").addEventListener("click", async () => {
  const fileInput = document.getElementById("csvFileInvoice");
  const msgDiv = document.getElementById("csvMsg");
  const btn = document.getElementById("btnUploadCSV");

  if (!fileInput.files || fileInput.files.length === 0) {
    msgDiv.innerHTML = '<span class="text-red-600">âŒ CSV dosyasÄ± seÃ§ lÃ¼tfen</span>';
    return;
  }

  const file = fileInput.files[0];
  const formData = new FormData();
  formData.append('file', file);
  formData.append('store_id', '1');
  formData.append('supplier_id', '1');

  btn.disabled = true;
  btn.innerHTML = 'YÃ¼kleniyor...';
  msgDiv.innerHTML = '<span class="text-blue-600">â³ Ä°ÅŸleniyor...</span>';

  try {
    const response = await fetch('/invoice/upload_csv', {
      method: 'POST',
      body: formData,
      headers: {
        'Authorization': 'Basic ' + btoa('admin:retailai2025')
      }
    });

    const result = await response.json();

    if (response.ok && result.ok) {
      msgDiv.innerHTML = `<span class="text-green-600">âœ… ${result.message}<br/>
        ğŸ“„ Fatura No: <strong>${result.invoice_no}</strong> (ID: ${result.invoice_id})<br/>
        ğŸ“¦ ${result.lines_created} Ã¼rÃ¼n, ${result.batches_created} batch oluÅŸturuldu</span>`;

      // Otomatik olarak yeni faturayÄ± gÃ¶ster
      setTimeout(() => {
        document.getElementById('invId').value = result.invoice_id;
        loadInvoice(result.invoice_id);
      }, 1500);
    } else {
      msgDiv.innerHTML = `<span class="text-red-600">âŒ Hata: ${result.message || 'Bilinmeyen hata'}</span>`;
    }
  } catch (error) {
    msgDiv.innerHTML = `<span class="text-red-600">âŒ BaÄŸlantÄ± hatasÄ±: ${error.message}</span>`;
  } finally {
    btn.disabled = false;
    btn.innerHTML = 'YÃ¼kle & Ä°ÅŸle';
  }
});

// Sayfa aÃ§Ä±lÄ±ÅŸta ?id= varsa otomatik yÃ¼kle
const urlParams = new URLSearchParams(window.location.search);
const autoId = urlParams.get('id');
if (autoId) {
  document.getElementById('invId').value = autoId;
  loadInvoice(autoId);
}
</script>

</body>
</html>